{% extends "base.html" %}

{# load seo #}
{% load i18n %}
{% load imagekit %}

{% comment %}
    Input Parameters:
        :<request> - Request

        :<post>
{% endcomment %}

{% block title %}{% trans "Post" %} "{{ post.title }}" - {{ block.super }}{% endblock %}

{% block extra_meta %}
{% comment %}
    {% get_metadata %}

    <link rel="image_src" href="{{ post.avatar.url }}" />
    <meta name="description" content="{{ post.content|striptags|truncatechars:300 }}" />
{% endcomment %}
{% endblock %}

{% block extra_style %}
{% endblock %}

{% block extra_script %}
{% endblock %}

{% block breadcrumbs %}
<div class="container">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb p-3 bg-body-tertiary">
            <li class="breadcrumb-item"><a href="{% url 'index' %}">Home</a></li>
            <li class="breadcrumb-item"><a href="{% url 'post-list' %}">{% trans "Blog" %}</a></li>
            <li class="breadcrumb-item active" aria-current="page">{{ post.title }}</li>
        </ol>
    </nav>
</a>
{% endblock %}

{% block content %}
<div id="post-details" class="bg-body-tertiary p-3">
    <div class="row g-2">
        <div class="col-md-9">
            <!-- START POST CARD -->
            <section id="post-card">
                <div class="card mb-3 shadow">
                    <div class="row g-0">
                        <div class="img-preview col-12">
                        {% if post.cover %}
                            {% generateimage "common:medium_fill_wide" source=post.cover -- alt=post.title class='img-fluid rounded-top' %}
                        {% else %}
                        {% endif %}
                        </div>
                    </div>

                    <div class="row g-0">
                        <div class="col-12">
                            <div class="card-body">
                                <h4 class="card-title mb-0">
                                {% if post.is_draft %}
                                    <span><i class="bi bi-vector-pen"></i><sup>{% trans "Draft" %}</sup></span>
                                {% endif %}
                                    {{ post.title|truncatechars:50 }}
                                </h4>

                                <p class="card-text">
                                {% if post.tags.all and post.hashtag %}
                                    <i class="bi bi-tags"></i>&nbsp;{% for tag in post.tags.all %}<a href="?tag={{ tag.id }}">{{ tag.name }}</a>{% if not forloop.last %}, {% endif %}{% endfor %}
                                    <span class="vert-delimiter">|</span>
                                    <i class="bi bi-hash"></i>{{ post.hashtag }}
                                {% elif post.tags.all %}
                                    <i class="bi bi-tags"></i>&nbsp;{% for tag in post.tags.all %}<a href="?tag={{ tag.id }}">{{ tag.name }}</a>{% if not forloop.last %}, {% endif %}{% endfor %}
                                {% elif post.hashtag %}
                                    <i class="bi bi-hash"></i>{{ post.hashtag }}>
                                {% endif %}
                                </p>

                                <p class="card-text">
                                {% if post.author.profile.avatar %}
                                    {% generateimage "header:thumbnail" source=post.author.profile.avatar -- alt=post.author.profile.auth_name %}
                                {% else %}
                                    <img src="{{ STATIC_URL }}img/no-avatar.png" height="30" width="30" alt="" />
                                {% endif %}
                                    {% trans "Posted by" %}
                                    <a href="{% url 'profile-view' post.author_id %}">{{ post.author.first_name }}</a>
                                    {{ post.created|timesince }} {% trans "ago" %}
                                </p>
                            </div>

                            <div class="card-footer bg-transparent border-success">
                                <p class="card-text">
                                    <small class="text-muted">
                                        <i class="bi bi-feather"></i>&nbsp;{{ post.get_comments_count }}
                                        <span class="vert-delimiter">|</span>
                                        <i class="bi bi-eye"></i>&nbsp;{{ post.get_views_count }}<br/>
                                        {% trans "Last updated" %} {{ post.modified|timesince }} {% trans "ago" %}
                                    </small>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            <!--  END  POST CARD -->

            <section id="post-content">
            {% autoescape off %}
                {{ post.content }}
            {% endautoescape %}
            </section>

            <!-- START POST COMMENTS -->
            <section id="post-comments">
            {% if not post.is_draft %}
                <h3>
                    {% trans "Comments" %}
                    <a data-bs-toggle="collapse" data-bs-target="#collapse-comments" aria-expanded="false" aria-controls="collapse-comments"><i class="bi bi-chevron-bar-contract"></i></a>
                {% if request.user.is_authenticated %}
                    <a class="add-comment btn btn-primary" href="#"><i class="bi bi-plus"></i></a>
                {% endif %}
                </h3>
                {% include "app/fragments/instance-comments.html" with instance=post %}
            {% endif %}
            </section>
            <!--  END  POST COMMENTS -->
        </div>

        <div id="tips" class="col-md-3 right-sidebar">
            <!-- Media -->
            {% include "blog/fragments/post-media-status-breakdown.html" %}

            <!-- Link to Page -->
            <h4>{% trans "Link to this Page" %}</h4>
            <input type="text" readonly="readonly" onclick="$(this).select();" value="{{ request.build_absolute_uri }}" />

            <!-- Share Links -->
            <h4>{% trans "Share" %}</h4>
            {% include "app/fragments/share-on-social.html" %}
        </div>
    </div>
</div>

<!-- Modals -->
{% if request.user.is_authenticated %}
    {% if request.user.is_staff %}
        {% include "blog/modals/post-publish-modal.html" %}
    {% endif %}

    {# include "app/modals/comment-add-modal.html" #}
    {# include "app/modals/complaint-add-modal.html" #}
{% endif %}

<script type="text/javascript">
    /*************************************************************************/
    /*** Add Comment                                                       ***/
    /*************************************************************************/
{% comment %}
    $(".add-comment").click(function (event) {
        element = $(this);

        var event = window.event || event;

        event.preventDefault();

        var post_id = "{{ post.id }}";

        $("#comment-add-modal-form").find("input[name='post_id']").val(post_id);
        $("#commentAddPopupModal").modal("show");
    })
{% endcomment %}

    /*************************************************************************/
    /*** Delete Comment                                                    ***/
    /*************************************************************************/
{% comment %}
    $(".delete-comment").click(function (event) {
        element = $(this);

        var event = window.event || event;

        event.preventDefault();

        var comment_id = $(this).attr("comment");

        $.ajax({
            url:    "{% url 'api-comment-details' 0 %}".replace("0", comment_id),
            type:   "DELETE"
        }).done(function (data) {
            console.log("Success");
            console.log("Data :", data);

            $(element).parent().parent().hide("slow");

            new Noty({
                type:   "info",
                text:   data.message
            }).show();
        }).fail(function (data) {
            console.log("Fail");
            console.log("Data :", data);

            try {
                new Noty({
                    type:   "error",
                    text:   data.responseJSON.message
                }).show();
            } catch (err) {
                new Noty({
                    type:   "error",
                    text:   "Failed to delete the Comment."
                }).show();
            };
        });

        return true;
    })
{% endcomment %}
</script>

<script type="text/javascript">
    /*************************************************************************/
    /*** Global Variables                                                  ***/
    /*************************************************************************/
    var element;
</script>
{% endblock %}
